{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": { "description": "Azure region" }
    },
    "namePrefix": {
      "type": "string",
      "defaultValue": "ohmyopen",
      "minLength": 2,
      "metadata": { "description": "Resource name prefix (must start with a letter for some resources)" }
    },
    "appServicePlanName": {
      "type": "string",
      "defaultValue": "[toLower(concat(parameters('namePrefix'), '-plan-', uniqueString(resourceGroup().id)))]"
    },
    "webAppName": {
      "type": "string",
      "defaultValue": "[toLower(concat(parameters('namePrefix'), '-web-', uniqueString(resourceGroup().id)))]"
    },
    "pgServerName": {
      "type": "string",
      "defaultValue": "[toLower(concat(parameters('namePrefix'), '-pg-', uniqueString(resourceGroup().id)))]",
      "metadata": { "description": "PostgreSQL Flexible Server name (must be globally unique)" }
    },
    "pgAdminUser": {
      "type": "string",
      "defaultValue": "blogadmin"
    },
    "pgAdminPassword": {
      "type": "secureString",
      "metadata": { "description": "PostgreSQL admin password" }
    },
    "pgDbName": {
      "type": "string",
      "defaultValue": "blogdb"
    },
    "secretKey": {
      "type": "secureString",
      "metadata": { "description": "Django SECRET_KEY (must be set when DEBUG=0)" }
    },
    "allowedHosts": {
      "type": "string",
      "defaultValue": "",
      "metadata": { "description": "Comma-separated ALLOWED_HOSTS. Leave empty to default to <webAppName>.azurewebsites.net" }
    },
    "createStorage": {
      "type": "bool",
      "defaultValue": true
    },
    "storageAccountName": {
      "type": "string",
      "defaultValue": "[toLower(substring(replace(concat(parameters('namePrefix'), uniqueString(resourceGroup().id)), '-', ''), 0, min(length(replace(concat(parameters('namePrefix'), uniqueString(resourceGroup().id)), '-', '')), 24)))]",
      "metadata": { "description": "Storage account name (3-24 lowercase letters/numbers)" }
    }
  },
  "variables": {
    "webAppDefaultHostname": "[concat(parameters('webAppName'), '.azurewebsites.net')]",
    "allowedHostsValue": "[if(equals(parameters('allowedHosts'), ''), variables('webAppDefaultHostname'), parameters('allowedHosts'))]",
    "pgFqdn": "[concat(parameters('pgServerName'), '.postgres.database.azure.com')]",
    "databaseUrl": "[concat('postgresql://', parameters('pgAdminUser'), ':', parameters('pgAdminPassword'), '@', variables('pgFqdn'), ':5432/', parameters('pgDbName'), '?sslmode=require')]"
  },
  "resources": [
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2024-04-01",
      "name": "[parameters('appServicePlanName')]",
      "location": "[parameters('location')]",
      "kind": "linux",
      "sku": { "name": "B1", "tier": "Basic", "capacity": 1 },
      "properties": { "reserved": true }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2024-04-01",
      "name": "[parameters('webAppName')]",
      "location": "[parameters('location')]",
      "kind": "app,linux",
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
      ],
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
        "httpsOnly": true,
        "siteConfig": {
          "linuxFxVersion": "PYTHON|3.11"
        }
      }
    },
    {
      "type": "Microsoft.Web/sites/config",
      "apiVersion": "2024-04-01",
      "name": "[format('{0}/appsettings', parameters('webAppName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
      ],
      "properties": {
        "DEBUG": "0",
        "SECRET_KEY": "[parameters('secretKey')]",
        "ALLOWED_HOSTS": "[variables('allowedHostsValue')]",
        "DATABASE_URL": "[variables('databaseUrl')]",
        "WEBSITE_RUN_FROM_PACKAGE": "1",
        "SCM_DO_BUILD_DURING_DEPLOYMENT": "true"
      }
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers",
      "apiVersion": "2024-08-01",
      "name": "[parameters('pgServerName')]",
      "location": "[parameters('location')]",
      "sku": { "name": "Standard_B1ms", "tier": "Burstable" },
      "properties": {
        "administratorLogin": "[parameters('pgAdminUser')]",
        "administratorLoginPassword": "[parameters('pgAdminPassword')]",
        "version": "16",
        "storage": { "storageSizeGB": 32, "autoGrow": "Enabled" },
        "backup": { "geoRedundantBackup": "Disabled" },
        "highAvailability": { "mode": "Disabled" },
        "network": { "publicNetworkAccess": "Enabled" }
      }
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers/databases",
      "apiVersion": "2024-08-01",
      "name": "[format('{0}/{1}', parameters('pgServerName'), parameters('pgDbName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('pgServerName'))]"
      ],
      "properties": { "charset": "UTF8", "collation": "en_US.UTF8" }
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers/firewallRules",
      "apiVersion": "2024-08-01",
      "name": "[format('{0}/{1}', parameters('pgServerName'), 'AllowAzureServices')]",
      "dependsOn": [
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('pgServerName'))]"
      ],
      "properties": { "startIpAddress": "0.0.0.0", "endIpAddress": "0.0.0.0" }
    },
    {
      "condition": "[parameters('createStorage')]",
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2024-01-01",
      "name": "[parameters('storageAccountName')]",
      "location": "[parameters('location')]",
      "kind": "StorageV2",
      "sku": { "name": "Standard_LRS" },
      "properties": { "supportsHttpsTrafficOnly": true }
    }
  ],
  "outputs": {
    "webAppName": { "type": "string", "value": "[parameters('webAppName')]" },
    "webAppUrl": { "type": "string", "value": "[concat('https://', variables('webAppDefaultHostname'))]" },
    "postgresHost": { "type": "string", "value": "[variables('pgFqdn')]" },
    "postgresDatabase": { "type": "string", "value": "[parameters('pgDbName')]" },
    "storageAccountName": {
      "type": "string",
      "value": "[if(parameters('createStorage'), parameters('storageAccountName'), '')]"
    }
  }
}
